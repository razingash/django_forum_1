{% extends 'forum/base.html' %}

{% load static %}
{% load forum_tags %}

{% block additional_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'forum/css/advanced_search.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'forum/css/dda_search_discussions.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'forum/css/pagination.css' %}">
    <meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block additional_js %}
    <script src="{% static 'forum/js/advanced_search.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>//sortirovka
    $(document).ready(function() {
        $('.bunch__apply').on('click', function() {
            // Создаем объект, в котором будем хранить данные для отправки на сервер
            var tags_p = [];
            var tags_n = [];
            var p_orients_p = [];
            var p_orients_n = [];
            var csrfToken = $('meta[name=csrf-token]').attr('content');
            var minLvl = $('#author__lvl__minimal').val().trim();
            var maxLvl = $('#author__lvl__maximal').val().trim();
            var level_limits = {};

            // Если значения являются числовыми, добавляем их в объект postData
            if (!isNaN(minLvl)) {
                level_limits['min'] = minLvl;
            }
            if (!isNaN(maxLvl)) {
                level_limits['max'] = maxLvl;
            }

            $('.bunch__tag__checkbox').each(function() {
                var id = $(this).attr('id');
                var value = $(this).val();

                if (value === '1') {
                    tags_p.push(id);
                }
                else if (value === '2') {
                    tags_n.push(id);
                }
            });
            $('.p_orientation__checkbox').each(function() {
                // Получаем id и value текущего элемента
                var id = $(this).attr('id');
                var value = $(this).val();

                if (value === '1') {
                    p_orients_p.push(id);
                }
                if (value === '2') {
                    p_orients_n.push(id);
                }
            });

            $.ajax({
                type: "POST",
                headers: {
                    'X-CSRFToken': csrfToken
                },
                url: "http://127.0.0.1:8000/forum/discussions/",
                contentType: 'application/json',
                data: JSON.stringify({
                    'request_type': 'advanced_search',
                    'level_limits': level_limits,
                    'tags_p': tags_p,
                    'tags_n': tags_n,
                    'p_orients_p': p_orients_p,
                    'p_orients_n': p_orients_n
                }),
                success: function(response) {
                    if (response.reload_page) {
                        location.reload();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка при отправке POST запроса:', error);
                }
            });
        });
    });
</script>
<script>
$(document).ready(function(){
    var csrfToken = $('meta[name=csrf-token]').attr('content');
    $('.grade_up').on('click', function(){
        var discussion_id = $(this).closest('.preview').attr('id');
        $.post({
            url: 'http://127.0.0.1:8000/forum/discussions/',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: {
                'request_type': 'discussion_grade',
                'action': 'up',
                'discussion_id': discussion_id,
                'user_id': {{ user.id }}
            },
            success: function(response) {
                console.log(response.new_rating)
                $('#' + discussion_id + ' .preview-rating').text(response.new_rating);
            },
            error: function(xhr, errmsg, err) {
                console.log(err);
            }
        });
    });

    $('.grade_down').on('click', function(){
        var discussion_id = $(this).closest('.preview').attr('id');
        $.post({
            url: 'http://127.0.0.1:8000/forum/discussions/',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: {
                'request_type': 'discussion_grade',
                'action': 'down',
                'discussion_id': discussion_id,
                'user_id': {{ user.id }}
            },
            success: function(response) {
                console.log(response.new_rating)
                $('#' + discussion_id + ' .preview-rating').text(response.new_rating);
            },
            error: function(xhr, errmsg, err) {
                console.log(err);
            }
        });
    });
});
</script>
{% endblock %}

{% block content %}
<div class="advanced_search__container">
    <div class="search__container__header">
        <div class="advanced_search" id="advanced_search_button_1">Advanced search</div>
        {% if request.user.is_authenticated %}
            <a href="{% url 'new_discussion' %}" class="new_discussion">create discussion</a>
        {% endif %}
        <form class="advanced_search__form">
            <input type="text" placeholder="Search here..." class="search__input">
        </form>
        <div class="search__form__results">
            <a href="#" class="search__form__result">theme 1</a>
            <a href="#" class="search__form__result">theme 2</a>
            <a href="#" class="search__form__result">theme 3</a>
            <a href="#" class="search__form__result">theme 4</a>
            <a href="#" class="search__form__result">theme 5</a>
        </div>
    </div>
</div>
<div class="content-field">
    <div class="universal-search-field custom__search__field">
    {% for discussion in discussions %}
        <div class="preview custom__preview" id="{{ discussion.pk }}">
            <div class="preview-header">
                <div class="preview-upload_date">{{ discussion.creation_date|date:"d.m.Y" }}</div>
                <div class="preview-visitors">
                    <svg class="svg__visitors">
                        <use xlink:href="#icon_visitors"></use>
                    </svg>
                    <div class="visitors__amount">?</div>
                </div>
            </div>
            <a href="{{ discussion.get_absolute_url }}" class="preview-theme custom__theme">{{ discussion.theme }}</a>
            <div class="preview-tags">
                {% discussion_tags discussion.discussiontags_set.all as discussion_categories %}
                {% for key, value in discussion_categories.items %}
                    <div class="preview-tag">{{ key }} {{ value }}</div>
                {% endfor %}
            </div>
            <div class="preview-footer">
                <div class="grade_fluctuations">
                    <svg class="grade_up">
                        <use xlink:href="#icon_arrow"></use>
                    </svg>
                    {% if discussion.rating == 0 %}
                        <div class="preview-rating grade-standard">{{ discussion.rating }}</div>
                    {% elif discussion.rating > 0 %}
                        <div class="preview-rating grade-positive">{{ discussion.rating }}</div>
                    {% else %}
                        <div class="preview-rating grade-negative">{{ discussion.rating }}</div>
                    {% endif %}
                    <svg class="grade_down">
                        <use xlink:href="#icon_arrow_bottom"></use>
                    </svg>
                </div>
                <a href="{{ discussion.get_absolute_url }}" class="preview-check custom__check">read...</a>
            </div>
        </div>
    {% endfor %}
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="pagination__link link__clickable"><</a>
            {% else %}
                <a class="pagination__link link__unclickable"><</a>
            {% endif %}
            {% for p in page_obj.paginator.page_range %}
                {% if page_obj.number == p %}
                    <a href="?page={{ p }}" class="pagination__link link-selected">{{ p }}</a>
                {% elif p >= page_obj.number|add:-3 and p <= page_obj.number|add:3 %}
                    <a href="?page={{ p }}" class="pagination__link">{{ p }}</a>
                {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="pagination__link link__clickable">></a>
            {% else %}
                <a class="pagination__link link__unclickable">></a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div class="advanced_search__field">
        <div class="search__container__footer">
            <div class="advanced_search__sorting">Sorted by</div>
            <div id="advanced_search_button_2" class="advanced_search">Advanced search</div>
        </div>
        <div class="advanced_search__bunch">
            <div class="hedge">
                <span class="bunch__hedge_top"></span>
            </div>
            <div class="scrollable_container">
                <div class="bunch__header">
                    <div>Author</div>
                    <div id="user_info__reset" class="advanced_search__reset">reset</div>
                </div>
                <div class="bunch__author">
                    <div class="author__lvl">
                        <div>level</div>
                        <input type="text" maxlength="4" placeholder="from" id="author__lvl__minimal" class="author__lvl__input">
                        <input type="text" maxlength="4" placeholder="to" id="author__lvl__maximal" class="author__lvl__input">
                    </div>
                    <div class="author__p_orientation">
                    {% for choice in p_orient %}
                        <label class="p_orientation__item">
                            <input type="checkbox" class="p_orientation__checkbox" id="7" value="0">
                            <div class="checkbox__item"></div>
                            <div>{{ choice.1 }}</div>
                        </label>
                    {% endfor %}
                    </div>
                </div>
                <div class="bunch__header">
                    <div>Tags</div>
                    <div id="tags__reset" class="advanced_search__reset">reset</div>
                </div>
                <div class="bunch__tags">
                {% for tag in tags %}
                    <label class="bunch__tag">
                        <input type="checkbox" class="bunch__tag__checkbox" id="{{ tag.id }}" value="0">
                        <div class="checkbox__item"></div>
                        <div>{{ tag.name }}</div>
                    </label>
                {% endfor %}
                </div>
            </div>
            <div class="hedge">
                <span class="bunch__hedge_bottom"></span>
            </div>
            <div class="bunch__footer">
                <div class="advanced_search__sorting" id="header__sorting">Sorted by</div>
                <div class="bunch__cancle">cancle</div>
                <div class="bunch__apply">apply</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
